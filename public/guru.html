<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Guru - Videa Class</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="css/guru.css?v=final" />
  </head>
  <body>
    <div class="container">
      <div class="header-actions">
        <a href="/" class="btn-back">‚¨Ö Dashboard</a>
        <button onclick="downloadPDF()" class="btn-print">
          üñ®Ô∏è Download Laporan PDF
        </button>
      </div>

      <div class="header-actions secondary-header">
        <button
          onclick="toggleInputPanel()"
          class="btn-print"
          id="btn-toggle-input"
        >
          ‚ûï Buka Panel Input Soal Manual
        </button>
      </div>

      <div class="input-group-wrapper">
        <label class="label-cyan"> Kode Kelas/Ujian (Wajib diisi): </label>
        <input
          type="text"
          id="input-kode-kelas"
          class="soal-input input-border-orange"
          placeholder="Contoh: IPA_UTS_1"
        />
      </div>

      <div id="input-soal-panel" class="container-input hidden">
        <h2>‚úçÔ∏è Input Soal Baru</h2>
        <p class="text-muted-small">
          Simpan soal manual untuk Ujian Khusus/Kelas Tertentu.
        </p>

        <label>Kode Kelas/Ujian Khusus (Contoh: IPA7A_UTS):</label>

        <input
          type="text"
          id="input-kode-kelas-manual"
          class="soal-input mb-20"
          placeholder="Masukkan kode kelas. WAJIB DIISI."
        />

        <div class="input-row">
          <label>Pilih Game:</label>
          <select id="input-game" aria-label="Pilih Game">
            <option value="math">Math Battle</option>
            <option value="nabi">Jejak Nabi</option>
            <option value="ayat">Sambung Ayat</option>
            <option value="kasir">Kasir Cilik</option>
            <option value="labirin">Labirin Ilmu</option>
          </select>

          <label>Pilih Level:</label>
          <select id="input-level" aria-label="Pilih Level Kesulitan">
            <option value="mudah">Mudah</option>
            <option value="sedang">Sedang</option>
            <option value="sulit">Sulit</option>
          </select>
        </div>

        <div id="soal-input-area">
          <p class="text-info-yellow">
            Pilih Game di atas untuk memuat template input.
          </p>
        </div>

        <div class="container-input container-priority">
          <h3>‚öôÔ∏è PRIORITAS PENGAMBILAN SOAL</h3>
          <p class="text-desc">
            Atur sumber utama soal untuk game ini (berlaku untuk semua
            siswa/publik).
          </p>

          <div class="input-row flex-wrap">
            <label class="label-orange">Sumber Umum:</label>
            <select
              id="content-source-selector"
              onchange="saveContentSource()"
              aria-label="Pilih Sumber Soal"
            >
              <option value="CACHE_FIRST">1. Cache Sistem (Hemat Kuota)</option>
              <option value="AI_ONLY">2. Gemini AI Saja (Fresh Content)</option>
            </select>
            <div id="current-setting-display" class="status-display">
              (Current: CACHE_FIRST)
            </div>
          </div>
        </div>

        <button onclick="saveManualQuestion()" class="btn-start mt-20">
          üíæ Simpan Soal Ujian Khusus
        </button>
      </div>

      <h1>üìã DATA SISWA & NILAI (V2.0)</h1>

      <div id="user-status-info" class="text-center mb-20"></div>

      <input
        type="text"
        id="search"
        class="search-box"
        placeholder="üîç Cari nama siswa..."
        onkeyup="filterTable()"
      />

      <div class="table-wrapper">
        <table id="tabel-nilai">
          <thead>
            <tr>
              <th class="col-nama">Nama Siswa</th>
              <th>Math</th>
              <th>Zuma</th>
              <th>Memory</th>
              <th>Piano</th>
              <th>Kasir</th>
              <th>Labirin</th>
              <th class="agama">Nabi</th>
              <th class="agama">Ayat</th>
              <th>TOTAL</th>
              <th>Role</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr>
              <td colspan="11" class="text-center">Memuat Data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
      // --- CONFIG FIREBASE ---
      const firebaseConfig = {
        apiKey: "AIzaSyApeL2uxjjfsiwtHhCd4mmgWT0biz-nI84",
        authDomain: "mathgamesd.firebaseapp.com",
        databaseURL:
          "https://mathgamesd-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "mathgamesd",
        storageBucket: "mathgamesd.firebasestorage.app",
        messagingSenderId: "595640141584",
        appId: "1:595640141584:web:d02523bc844e52550f4795",
      };
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (e) {}
      const auth = firebase.auth();
      const database = firebase.database();

      let currentUserRole = "siswa";
      let currentUserName = "";

      // --- AUTH & SECURITY (ROLE CHECK) ---
      auth.onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = "/";
        } else {
          currentUserName = user.displayName;
          database
            .ref("leaderboard/" + user.displayName)
            .once("value")
            .then((snapshot) => {
              const data = snapshot.val();
              currentUserRole = data ? data.role : "siswa";

              if (currentUserRole !== "guru" && currentUserRole !== "admin") {
                alert("Akses Ditolak! Halaman ini khusus Guru.");
                window.location.href = "/";
              } else {
                const infoBox = document.getElementById("user-status-info");
                // MENGGUNAKAN CLASS CSS (Bukan Inline Style Lagi)
                if (currentUserRole === "admin") {
                  infoBox.innerHTML = `<span class="badge-info text-red-bold" style="border-color:#ef473a">ANDA ADMIN (FULL KONTROL)</span>`;
                } else {
                  infoBox.innerHTML = `<span class="badge-info text-green-bold">ANDA GURU (TERBATAS)</span>`;
                }
                loadDataSiswa();
                loadInputTemplate();
              }
            });
        }
      });

      // --- LOGIKA BARU CMS GURU ---

      // 1. TOGGLE PANEL
      window.toggleInputPanel = function () {
        const panel = document.getElementById("input-soal-panel");
        const btn = document.getElementById("btn-toggle-input");

        if (currentUserRole !== "guru" && currentUserRole !== "admin") {
          alert("Akses Ditolak! Anda bukan Guru/Admin.");
          return;
        }

        if (panel.classList.contains("hidden")) {
          panel.classList.remove("hidden");
          btn.innerText = "‚ûñ Tutup Panel Input Soal";
          loadInputTemplate();
          loadContentSourceSettings();
        } else {
          panel.classList.add("hidden");
          btn.innerText = "‚ûï Buka Panel Input Soal Manual";
        }
      };

      // 2. LOAD TEMPLATE INPUT SOAL
      document
        .getElementById("input-game")
        .addEventListener("change", loadInputTemplate);
      document
        .getElementById("input-level")
        .addEventListener("change", loadInputTemplate);

      function loadInputTemplate() {
        if (currentUserRole !== "guru" && currentUserRole !== "admin") return;

        const game = document.getElementById("input-game").value;
        const area = document.getElementById("soal-input-area");
        let html = "";

        if (game === "math" || game === "kasir" || game === "labirin") {
          html = `
            <label>Soal/Cerita (${game.toUpperCase()}):</label>
            <textarea id="input-tanya" class="soal-input" rows="3" placeholder="Masukkan soal cerita atau pertanyaan..."></textarea>
            <label>Jawaban Kunci (Angka, Teks Singkat, atau Jawaban Kasir):</label>
            <input type="text" id="input-jawab" class="soal-input" placeholder="Misal: 1000 atau Satuan Jarak">
          `;
        } else if (game === "nabi" || game === "ayat") {
          html = `
            <label>Pertanyaan:</label>
            <textarea id="input-tanya" class="soal-input" rows="2" placeholder="Teks soal yang akan ditampilkan..."></textarea>
            <label>Opsi Jawaban A (BENAR - KUNCI):</label>
            <input type="text" id="input-opsi-a" class="soal-input" placeholder="Opsi A (Wajib Jawaban Benar)">
            <label>Opsi Jawaban Lain (B):</label>
            <input type="text" id="input-opsi-b" class="soal-input" placeholder="Opsi B">
            <label>Opsi Jawaban Lain (C):</label>
            <input type="text" id="input-opsi-c" class="soal-input" placeholder="Opsi C">
            <label>Opsi Jawaban Lain (D):</label>
            <input type="text" id="input-opsi-d" class="soal-input" placeholder="Opsi D">
          `;
        } else {
          // Menggunakan Class .error-msg
          html = `<p class="error-msg">Input manual untuk game ini belum didukung.</p>`;
        }

        area.innerHTML = html;
        loadContentSourceSettings();
      }

      // 3. SAVE MANUAL QUESTION
      window.saveManualQuestion = function () {
        if (currentUserRole !== "guru" && currentUserRole !== "admin") {
          alert("Akses Ditolak! Hanya Guru/Admin yang bisa menyimpan soal.");
          return;
        }

        const game = document.getElementById("input-game").value;
        const level = document.getElementById("input-level").value;

        // MENGGUNAKAN ID YANG SUDAH DIPERBAIKI (input-kode-kelas-manual)
        const kodeKelas = document
          .getElementById("input-kode-kelas-manual")
          .value.trim()
          .toUpperCase();

        if (!kodeKelas) {
          alert("Kode Kelas/Ujian wajib diisi untuk menyimpan soal manual!");
          return;
        }

        let dataToSave = null;

        if (game === "math" || game === "kasir" || game === "labirin") {
          const tanya = document.getElementById("input-tanya").value;
          const jawab = document.getElementById("input-jawab").value;

          if (!tanya || !jawab) return alert("Soal dan Jawaban harus diisi!");

          const answer =
            game === "math" || game === "kasir"
              ? isNaN(parseInt(jawab))
                ? jawab
                : parseInt(jawab)
              : jawab;

          if (game === "math") dataToSave = { soal: tanya, jawaban: answer };
          else if (game === "kasir")
            dataToSave = { cerita: tanya, jawaban: answer };
          else if (game === "labirin")
            dataToSave = { tanya: tanya, jawab: jawab };
        } else if (game === "nabi" || game === "ayat") {
          const tanya = document.getElementById("input-tanya").value;
          const opsA = document.getElementById("input-opsi-a").value;
          let opsB, opsC, opsD;

          try {
            opsB = document.getElementById("input-opsi-b").value;
            opsC = document.getElementById("input-opsi-c").value;
            opsD = document.getElementById("input-opsi-d").value;
          } catch (e) {}

          if (!tanya || !opsA)
            return alert("Pertanyaan dan Jawaban BENAR (A) harus diisi!");

          dataToSave = {
            tanya: tanya,
            opsi: [opsA, opsB, opsC, opsD].filter(Boolean),
            jawab: opsA,
          };
        }

        if (dataToSave) {
          const contentRef = database.ref(
            `content_manual/${game}/${kodeKelas}/${level}`
          );
          contentRef
            .push(dataToSave)
            .then(() => {
              alert(
                `Soal ${game.toUpperCase()} Level ${level.toUpperCase()} dengan Kode Ujian (${kodeKelas}) berhasil disimpan!`
              );
            })
            .catch((error) => {
              alert("Gagal menyimpan: " + error.message);
              console.error(error);
            });
        } else {
          alert(
            "Pilihan game tidak didukung atau ada field yang belum terisi dengan benar."
          );
        }
      };

      // 4. LOAD SETTINGS
      function loadContentSourceSettings() {
        const game = document.getElementById("input-game").value;
        const selector = document.getElementById("content-source-selector");
        const display = document.getElementById("current-setting-display");

        if (currentUserRole !== "guru" && currentUserRole !== "admin") return;

        database
          .ref(`content_control/${game}`)
          .once("value")
          .then((snapshot) => {
            const setting = snapshot.val() || "CACHE_FIRST";
            selector.value = setting;
            display.innerText = `(Current: ${setting.replace("_", " ")})`;
          })
          .catch((error) => console.error("Gagal memuat pengaturan:", error));
      }

      // 5. SAVE SETTINGS
      window.saveContentSource = function () {
        if (currentUserRole !== "guru" && currentUserRole !== "admin") {
          alert("Akses Ditolak!");
          return;
        }

        const game = document.getElementById("input-game").value;
        const selector = document.getElementById("content-source-selector");
        const setting = selector.value;
        const display = document.getElementById("current-setting-display");

        if (
          confirm(
            `Ubah prioritas soal untuk ${game.toUpperCase()} menjadi ${setting.replace(
              "_",
              " "
            )}?`
          )
        ) {
          database
            .ref(`content_control/${game}`)
            .set(setting)
            .then(() => {
              alert("Pengaturan sumber berhasil disimpan!");
              display.innerText = `(Current: ${setting.replace("_", " ")})`;
            })
            .catch((error) =>
              alert("Gagal menyimpan pengaturan: " + error.message)
            );
        } else {
          loadContentSourceSettings();
        }
      };

      // --- TABEL DATA ---
      function loadDataSiswa() {
        database.ref("leaderboard").on("value", (snapshot) => {
          const data = snapshot.val();
          const tbody = document.getElementById("table-body");
          tbody.innerHTML = "";

          if (!data) return;

          const isEditable =
            currentUserRole === "admin" || currentUserRole === "guru"
              ? ""
              : "disabled";

          Object.keys(data).forEach((key) => {
            const user = data[key];
            let sMath = user.skor_math || 0;
            if (user.skor && !user.skor_math) sMath = user.skor;
            let sZuma = user.skor_zuma || 0;
            let sMemory = user.skor_memory || 0;
            let sPiano = user.skor_piano || 0;
            let sKasir = user.skor_kasir || 0;
            let sLabirin = user.skor_labirin || 0;
            let sNabi = user.skor_nabi || 0;
            let sAyat = user.skor_ayat || 0;

            let total =
              sMath +
              sZuma +
              sMemory +
              sPiano +
              sKasir +
              sLabirin +
              sNabi +
              sAyat;
            let targetRole = user.role || "siswa";

            let isDisabled = "";
            let adminOption = "";
            if (currentUserRole === "admin") {
              isDisabled = "";
              adminOption = `<option value="admin" ${
                targetRole === "admin" ? "selected" : ""
              }>Admin</option>`;
            } else {
              if (targetRole === "admin" || user.nama === currentUserName)
                isDisabled = "disabled";
              adminOption = "";
            }

            let roleControl = "";
            if (isDisabled === "disabled" && targetRole === "admin") {
              // MENGGUNAKAN CLASS CSS (text-red-bold)
              roleControl = `<span class="text-red-bold">ADMIN</span>`;
            } else {
              roleControl = `
                <select class="role-select role-${targetRole}" onchange="updateRole('${
                user.nama
              }', this.value, '${targetRole}')" ${isDisabled}>
                    <option value="siswa" ${
                      targetRole === "siswa" ? "selected" : ""
                    }>Siswa</option>
                    <option value="guru" ${
                      targetRole === "guru" ? "selected" : ""
                    }>Guru</option>
                    ${adminOption}
                </select>
              `;
            }

            const row = `
                <tr>
                    <td class="col-nama">
                        <div class="flex-align-center">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${user.nama}" class="avatar-mini">
                            <span>${user.nama}</span>
                        </div>
                    </td>
                    <td>${sMath}</td>
                    <td>${sZuma}</td>
                    <td>${sMemory}</td>
                    <td>${sPiano}</td>
                    <td>${sKasir}</td>
                    <td>${sLabirin}</td>
                    <td class="text-teal-bold">${sNabi}</td>
                    <td class="text-teal-bold">${sAyat}</td>
                    <td class="score-val">${total}</td>
                    <td>${roleControl}</td>
                </tr>
            `;
            tbody.innerHTML += row;
          });
        });
      }

      // Fungsi updateRole, filterTable, downloadPDF tetap sama (sudah aman)
      window.updateRole = function (targetName, newRole, oldRole) {
        if (currentUserRole !== "admin" && currentUserRole !== "guru") {
          alert("Anda tidak punya hak!");
          loadDataSiswa();
          return;
        }
        if (currentUserRole === "guru" && newRole === "admin") {
          alert("Guru tidak bisa mengangkat Admin!");
          loadDataSiswa();
          return;
        }
        if (
          confirm(`Ubah status ${targetName} menjadi ${newRole.toUpperCase()}?`)
        ) {
          database.ref("leaderboard/" + targetName).update({ role: newRole });
        } else {
          loadDataSiswa();
        }
      };

      window.filterTable = function () {
        const input = document.getElementById("search");
        const filter = input.value.toUpperCase();
        const rows = document
          .getElementById("table-body")
          .getElementsByTagName("tr");
        for (let i = 0; i < rows.length; i++) {
          let td = rows[i].getElementsByTagName("td")[0];
          if (td) {
            let txt = td.textContent || td.innerText;
            rows[i].style.display =
              txt.toUpperCase().indexOf(filter) > -1 ? "" : "none";
          }
        }
      };

      window.downloadPDF = function () {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("l", "mm", "a4");
        doc.setFontSize(18);
        doc.text("Laporan Nilai Siswa Lengkap - Videa Class", 14, 20);
        doc.setFontSize(10);
        const date = new Date().toLocaleDateString("id-ID", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        doc.text(`Dicetak pada: ${date}`, 14, 28);

        let dataBody = [];
        const rows = document.querySelectorAll("#table-body tr");
        rows.forEach((row) => {
          const cols = row.querySelectorAll("td");
          if (cols.length > 0 && row.style.display !== "none") {
            let nama = cols[0].innerText.trim();
            // Ambil data nilai, dsb. (Logic sama)
            // ... (Kode download PDF tetap sama, hanya memastikan HTML tabel bersih)
            let math = cols[1].innerText;
            let zuma = cols[2].innerText;
            let memory = cols[3].innerText;
            let piano = cols[4].innerText;
            let kasir = cols[5].innerText;
            let labirin = cols[6].innerText;
            let nabi = cols[7].innerText;
            let ayat = cols[8].innerText;
            let total = cols[9].innerText;
            let roleSelect = cols[10].querySelector("select");
            let role = roleSelect ? roleSelect.value : cols[10].innerText;

            dataBody.push([
              nama,
              math,
              zuma,
              memory,
              piano,
              kasir,
              labirin,
              nabi,
              ayat,
              total,
              role.toUpperCase(),
            ]);
          }
        });

        doc.autoTable({
          head: [
            [
              "Nama Siswa",
              "Math",
              "Zuma",
              "Memory",
              "Piano",
              "Kasir",
              "Maze",
              "Nabi",
              "Ayat",
              "Total",
              "Role",
            ],
          ],
          body: dataBody,
          startY: 35,
          theme: "grid",
          headStyles: { fillColor: [0, 242, 255], textColor: [0, 0, 0] },
          styles: { fontSize: 9 },
        });
        doc.save(
          `Laporan_Lengkap_${new Date().toISOString().slice(0, 10)}.pdf`
        );
      };
    </script>
  </body>
</html>
